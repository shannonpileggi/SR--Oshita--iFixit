---
title: "Predictive modeling with cross validation"
author: "Lisa Oshita"
date: "8/10/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
x <- oshitar::setup()
library(survival)
library(stringr)
```

### Creating cross-validation plan with k = 5

```{r, echo = FALSE}
splitPlan <- vtreat::kWayCrossValidation(nrow(x), 5, NULL, NULL)
str(splitPlan)
```

### Building the model on one of the training data sets

##### Univariate analyses 

```{r, echo = FALSE}
test1 <- x[splitPlan[[1]]$train, ]

#===================================================================
# Univariate analyses (select variables with p-value < 0.01)

# category 
x$category <- as.character(x$category)
x$category[is.na(x$category)] <- "Other"
x$category <- as.factor(x$category)
cr_cat <- coxph(Surv(time_until_answer, answered) ~ category, data = x)
summary(cr_cat) # p=0 

# n_images
cr_image <- coxph(Surv(time_until_answer, answered) ~ n_images, data = x)
summary(cr_image) # p=4.27e-06
x$new_n_images <- as.character(x$n_images) # recoding to group questions with >= 6 images 
x$new_n_images[x$n_images >= 6] <- ">= 6"
cr_image1 <- coxph(Surv(time_until_answer, answered) ~ new_n_images, data = x)
summary(cr_image1) # p=1.064e-05

# n_tags
cr_ntags <- coxph(Surv(time_until_answer, answered) ~ as.factor(n_tags), data = x)
summary(cr_ntags) # p=1.729e-09

# new_user
cr_user <- coxph(Surv(time_until_answer, answered) ~ as.factor(new_user), data = x)
summary(cr_user) # p=0

# weekday 
x$datetime <- as.POSIXct(x$post_date,origin="1970-01-01")
x$weekday <- factor(weekdays(x$datetime), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
cr_weekday <- coxph(Surv(time_until_answer, answered) ~ weekday, data = x)
summary(cr_weekday) # p=0.0002063

# is_weekend
x$is_weekend <- FALSE
x$is_weekend[x$weekday == "Saturday" | x$weekday == "Sunday"] <- TRUE
cr_weekend <- coxph(Surv(time_until_answer, answered) ~ is_weekend, data = x)
summary(cr_weekend) # p=0.001501

# hour of the day
x$hour <- as.numeric(format(x$datetime,"%H"))
cr_hour <- coxph(Surv(time_until_answer, answered) ~ hour, data = x)
summary(cr_hour) # p=0.4161

# morning/noon/evening/night?
x$ampm <- "Night"
x$ampm[x$hour >= 5 & x$hour < 12] <- "Morning"
x$ampm[x$hour >= 12 & x$hour < 17] <- "Afternoon" #noon - 5pm 
x$ampm[x$hour >= 17 & x$hour < 20] <- "Evening" #5pm - 8pm 
cr_ampm <- coxph(Surv(time_until_answer, answered) ~ ampm, data = x)
summary(cr_ampm) # p=2.128e-06

# title length 
x$title_length <- str_length(x$title)
cr_title_len <- coxph(Surv(time_until_answer, answered) ~ title_length, data = x)
summary(cr_title_len) # p=0.4185

# text length
x$text_length <- str_length(x$text)
cr_text_len <- coxph(Surv(time_until_answer, answered) ~ text_length, data = x)
summary(cr_text_len) # p=3.442e-15

# device name length
x$device_length <- str_length(x$device)
cr_device_len <- coxph(Surv(time_until_answer, answered) ~ device_length, data = x)
summary(cr_device_len) # p=0.0008583

# length of sentence until first punctuation mark 
x$length <- str_locate(x$text, pattern = "[.|?|!]")[,1]
q <- quantile(x$length, probs = seq(0, 1, by = 0.25), na.rm = TRUE)
x$text_till_punct <- "none"
x$text_till_punct[x$length <= q[2]] <- "short"
x$text_till_punct[x$length >= q[2] & x$length <= q[3]] <- "medium"
x$text_till_punct[x$length >= q[3] & x$length <= q[4]] <- "moderate"
x$text_till_punct[x$length >= q[4]] <- "long"
cr_tillpunct <- coxph(Surv(time_until_answer, answered) ~ text_till_punct, data = x)
summary(cr_tillpunct) # p=0.01604

# if text contains any end punctuation
x$text_contain_punct <- FALSE
x$text_contain_punct[!is.na(x$text_till_punct)] <- TRUE
cr_containpun <- coxph(Surv(time_until_answer, answered) ~ text_contain_punct, data = x)
summary(cr_containpun) # p=7.862e-11

# if the text ends in a punctuation
x$text_end_punct <- str_detect(x$text, pattern = "[.|?|!]$")
cr_endpunct <- coxph(Surv(time_until_answer, answered) ~ text_end_punct, data = x)
summary(cr_endpunct) # p=0.02284

# if the title ends with a question mark
library(rebus)
x$title_questionmark <- str_detect(x$title, pattern = QUESTION %R% END)
cr_title_q <- coxph(Surv(time_until_answer, answered) ~ title_questionmark, data = x)
summary(cr_title_q) # p=5.551e-16

# if title begins with "wh"
x$title_beginwh <- str_detect(str_to_lower(x$title), pattern = "^wh")
cr_begin <- coxph(Surv(time_until_answer, answered) ~ title_beginwh, data = x)
summary(cr_begin) # p=0.04327

# if first letter of title is capitalized
x$capital_title <- str_detect(as.character(x$title), pattern = "^[[:upper:]]")
cr_title <- coxph(Surv(time_until_answer, answered) ~ capital_title, data = x)
summary(cr_title) # p=0.9636

# if first letter of text is capitalized
x$capital_text <- str_detect(x$text, pattern = "^[[:upper:]]")

```


