---
title: "Exploring variables in the data"
output: 
  html_document: default
  pdf_document: default

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
dir <- file.path(getwd(),"data")
out <- read.csv(file.path(dir, "answers_data.csv"))

library(dplyr)
x <- out %>% 
  tbl_df() %>%
  filter(langid == "en")

x$time_until_answer <- (x$first_answer_date - x$post_date)/3600
empty <- which(is.na(x$time_until_answer))
for (i in empty) {
  x$time_until_answer[i] <- (x$download_date[i] - x$post_date[i])/3600
}

library(ggplot2)
library(survival)
library(epiR)
library(stringr)
library(rebus)
```


```{r, functions, include = FALSE}
#function to plot KM_curves with ggplot (use when it's hard to read ggsurvplot output)
#takes survfit object, data set to work with, and optional x-axis limits as input, outputs ggplot KM curves

plot_surv <- function(survfit, data, xlim = NULL) {
  library(ggfortify)
  library(directlabels)
  
  df <- fortify(survfit, data = data)
  
  if (missing(xlim)) {
      
    if (!("strata" %in% names(df))) {
        ggplot(df, aes(x = time, y = surv)) + 
          geom_line() + 
          scale_y_continuous("Survival Probability") +
          scale_x_continuous("Time (hours)")
          ggtitle("Survival Curve")
        }
    if ("strata" %in% names(df)) {
      ggplot(df, aes(x = time, y = surv, color = strata)) + 
        geom_line() + 
        scale_y_continuous("Survival Probabilities") +
        scale_x_continuous("Time (hours)") + 
        ggtitle("Survival Curves") + 
        geom_dl(aes(label = strata), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.5))
    }
  } else {
      
      if (!("strata" %in% names(df))) {
        ggplot(df, aes(x = time, y = surv)) + 
          geom_line() + 
          scale_y_continuous("Survival Probability") +
          scale_x_continuous("Time (hours)", limits = xlim)
          ggtitle("Survival Curve")
      }

      if ("strata" %in% names(df)) {
        ggplot(df, aes(x = time, y = surv, color = strata)) + 
          geom_line() + 
          scale_y_continuous("Survival Probabilities") +
          scale_x_continuous("Time (hours)", limits = xlim) + 
          ggtitle("Survival Curves") + 
          geom_dl(aes(label = strata), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.5))
      }
  }
}

```

### Category

##### number of questions within each category

```{r, echo = FALSE}
x %>%
  group_by(category) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
```

##### median/average time by category

```{r, echo = FALSE}
sorted <- x %>% 
  group_by(category) %>%
  summarise(n = n(), avg_time = mean(time_until_answer), median_time = median(time_until_answer), median_views = median(daily_views)) %>%
  arrange(median_time)
sorted
```

* **Categories with lowest median time_until_answer values:** `r as.character(sorted$category[1:5])`
* **Category with longest median time_until_answer:** `r last(as.character(sorted$category))`

##### log-rank test

```{r, echo = FALSE}
surv_object <- Surv(x$time_until_answer, x$answered, type = "right")

survdiff(surv_object~category, data = x)
KM_category <- survfit(surv_object~category, data = x)
plot_surv(KM_category, data = x)
```
##### zoomed in 
```{r, echo = FALSE}
plot_surv(KM_category, data = x, xlim = c(0,100))
```



##### Is there a difference between iphone and android users? 

```{r, echo = FALSE}
x %>% 
  filter(subcategory == c("iPhone", "Android Phone")) %>%
  group_by(subcategory) %>%
  summarise(median_time = median(time_until_answer), n = n(), avg_views = mean(daily_views))
```


### Whether or not the question was categorized correctly

```{r, echo = FALSE}
prop_incorrect <- sum(is.na(x$category))/nrow(x)
```

* `r round(prop_incorrect*100, 2)`% of questions were categorized incorrectly

##### log-rank test

```{r, echo = FALSE}
x$categorized <- 0
x$categorized[!is.na(x$category)] <- 1

survdiff(surv_object~categorized, data = x)
```

##### survival curves 

```{r, echo = FALSE}
KM_correct <- survfit(surv_object ~ as.factor(categorized), data = x)
plot_surv(KM_correct, data = x, xlim = c(0,100))
```


### Title Length

##### distribution of title lengths

```{r, title length, echo = FALSE}
x$title_length <- str_length(x$title)

ggplot(x, aes(x = title_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Question Title") + 
  ggtitle("Distribution of Title Lengths")

sum_length <- summary(x$title_length)
```

* **min title length:** `r sum_length[1]` characters
* **max title length:** `r sum_length[6]` characters
* **mean title length:** `r sum_length[4]`
* **median:** `r sum_length[3]`

##### average title length grouped by answered/unanswered questions

```{r, echo = FALSE}
x %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_titlelength = mean(title_length), median_titlelength = median(title_length), n = n())
```

##### average title length and median time grouped by category 

```{r, echo = FALSE}
x %>%
  group_by(category) %>%
  summarise(n = n(), avg_length = mean(title_length), median_time = median(time_until_answer)) %>%
  arrange(desc(avg_length))
```

### Text Length

```{r, echo = FALSE}
x$text_length <- str_length(x$text)

ggplot(x, aes(x = text_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Text") + 
  ggtitle("Distribution of Text Lengths")

sum_text <- summary(x$text_length)
```

* **min text length:** `r sum_text[1]` characters
* **max text length:** `r sum_text[6]` characters
* **mean text length:** `r sum_text[4]`
* **median:** `r sum_text[3]`

##### average/median text length and median time grouped by answered/unanswered questions

* may be evidence that questions with longer text length tend to get answered

```{r, echo = FALSE}
x %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_length = mean(text_length), median_length = median(text_length), median_time = median(time_until_answer), n = n())
```

##### determining which categories have the longest text lengths

```{r, echo = FALSE}
x %>%
  group_by(category) %>%
  summarise(avg_length = mean(text_length), median_length = median(text_length), n = n()) %>%
  arrange(desc(avg_length))
```

### Device name length

```{r, device length, echo = FALSE}
x$device_length <- str_length(x$device)

ggplot(x, aes(x = device_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Device Name") + 
  ggtitle("Distribution of Device Name Lengths")

sum_device <- summary(x$device_length)
```

* **min length:** `r sum_device[1]`
* **max length:** `r sum_device[6]`
* **mean length:** `r sum_device[4]`
* **median length:** `r sum_device[3]`

##### average and median device length grouped by answered/unanswered questions

```{r, echo = FALSE}
x %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_length = mean(device_length), median_length = median(device_length), n = n())
```

##### which categories have the longest device name lengths

```{r, echo = FALSE}
x %>%
  group_by(category) %>%
  summarise(avg_length = mean(device_length), median_length = median(device_length), n = n(), median_time = median(time_until_answer)) %>%
  arrange(desc(avg_length))
```


### n_tags

* n_tags included in questions: `r unique(x$n_tags)`
```{r, echo = FALSE}
prop_notags <- sum(x$n_tags == 0)/nrow(x)
```
* `r round(prop_notags * 100,2)`% of questions don't have any tags

##### proportion table for n_tags

```{r, echo = FALSE}
round(prop.table(table(x$n_tags)), 3)
```

##### median time and proportion of questions answered grouped by n_tags

* questions with more tags tend to have faster answer times and are more likely to get answers

```{r, echo = FALSE}
x %>%
  group_by(as.factor(n_tags)) %>%
  summarise(n = n(), median_time = median(time_until_answer), proportion_answered = sum(answered)/n, median_views = median(daily_views)) %>%
  arrange(median_time)
```

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(n_tags), data = x)
KM_tags <- survfit(surv_object~as.factor(n_tags), data = x)
plot_surv(KM_tags, data = x)
```


### n_images

```{r, echo = FALSE}
prop_hasimage <- sum(x$n_images != 0)/nrow(x)
```

* `r round(prop_hasimage * 100, 2)`% of questions contain at least one image

##### frequency table for n_images

```{r, echo = FALSE}
table(x$n_images)
```

##### median time and proportion answered grouped by whether or not question contains an image

* questions that include at least one image tend to have faster answer times

```{r, echo = FALSE}
x$pic_included <- 0
x$pic_included[x$n_images != 0] <- 1

x %>%
  group_by(as.factor(pic_included)) %>%
  summarise(median_time = median(time_until_answer), n = n(), proportion_answered = sum(answered)/n, median_views = median(daily_views)) %>%
  arrange(desc(proportion_answered))
```

##### log-rank test 

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(pic_included), data = x)
KM_pic <- survfit(surv_object~as.factor(pic_included), data = x)
plot_surv(KM_pic, data = x)
```


### new_user

```{r, echo = FALSE}
prop_new <- sum(x$new_user)/nrow(x)
```

* `r round(prop_new * 100, 2)`% of users asking a question were new

##### median time and proportion answered grouped by whether or not new user

```{r, echo = FALSE}
x %>% 
  group_by(as.factor(new_user)) %>%
  summarise(median_time = median(time_until_answer), n = n(), proportion_answered = sum(answered)/n) %>%
  arrange(desc(proportion_answered))
```

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(new_user), data = x)
KM_new <- survfit(surv_object~as.factor(new_user), data = x)
plot_surv(KM_new, data = x)
```

### daily_views

* **max average daily views for a question:** `r max(x$daily_views)`
* **min average daily views for a question:** `r min(x$daily_views)`
* **mean:** `r round(mean(x$daily_views), 2)`
* **median:** `r round(median(x$daily_views), 2)`


### Looking at when the question was posted

* unix time stamp: seconds since Jan 01 1970. (UTC)

```{r}
x$post_datetime <- as.POSIXct(x$post_date,origin="1970-01-01")
x$post_d <- format(x$post_datetime, "%m/%d/%y")
x$post_time <- format(x$post_datetime, " %H:%M:%S")
x$post_weekday <- factor(weekdays(x$post_datetime), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
x$post_hour <- as.numeric(format(x$post_datetime,"%H"))

x$post_ampm <- "Night"
x$post_ampm[x$post_hour >= 5 & x$post_hour < 12] <- "Morning"
x$post_ampm[x$post_hour >= 12 & x$post_hour < 17] <- "Afternoon" #noon - 5pm 
x$postampm[x$post_hour >= 17 & x$post_hour < 20] <- "Evening" #5pm - 8pm 

posn_d <- position_dodge(width = 0.2)
ggplot(x, aes(x = post_weekday, fill = as.factor(answered))) + 
  geom_bar(position = posn_d, alpha = 0.6) + 
  scale_y_continuous("Number of Questions") +
  ggtitle("Distribution of questions posted over a week")

library(gridExtra)

ggplot(x, aes(x = post_hour)) + 
  geom_bar() + 
  scale_y_continuous("Number of Questions") + 
  ggtitle("Distribution of all questions posted over a day") + 
  scale_x_continuous("Hour of the Day", breaks = seq(0, 23, by = 1))

ggplot(x, aes(x = post_hour, fill = as.factor(answered))) + 
  geom_bar(position = posn_d, alpha = 0.6) + 
  scale_y_continuous("Number of Questions") + 
  ggtitle("Distribution of questions posted over a day, grouped by answered/unanswered") +
  scale_x_continuous("Hour of the Day", breaks = seq(0, 23, by = 1))
```

##### Median time grouped by day of the week

```{r, echo = FALSE}
x %>%
  group_by(post_weekday) %>%
  summarise(median_time = median(time_until_answer), avg_views = mean(daily_views), n = n(), prop_answered = sum(answered)/n) %>%
  arrange(median_time)
```

##### Median time/avg views/prop answered grouped by hour

```{r, echo = FALSE}
x %>%
  group_by(as.factor(post_hour)) %>%
  summarise(n = n(), median_time = median(time_until_answer), avg_views = mean(daily_views), prop_answered = sum(answered)/n) %>%
  arrange(median_time)
  
```


##### Median time grouped by morning/afternoon

```{r, echo = FALSE}
x %>%
  group_by(post_ampm) %>%
  summarise(median_time = median(time_until_answer), avg_views = mean(daily_views), n = n(), prop_answered = sum(answered)/n)
```

##### log-rank test + survival curves for weekday 

```{r, echo = FALSE}
survdiff(surv_object ~ post_weekday, data = x)
KM_weekday <- survfit(surv_object ~ post_weekday, data = x)
plot_surv(KM_weekday, data = x)
```

##### log-rank test and survival curves for ampm 

```{r, echo = FALSE}
survdiff(surv_object ~ post_ampm, data = x)
KM_ampm <- survfit(surv_object ~ post_ampm, data = x)
plot_surv(KM_ampm, data = x)
```

### Looking at when answers are posted 

```{r, echo = FALSE}
x$ans_datetime <- as.POSIXct(x$first_answer_date, origin="1970-01-01")
x$ans_d <- format(x$ans_datetime, "%m/%d/%y")
x$ans_time <- format(x$ans_datetime, " %H:%M:%S")
x$ans_weekday <- factor(weekdays(x$ans_datetime), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
x$ans_hour <- as.numeric(format(x$ans_datetime,"%H"))

ggplot(subset(x, !is.na(ans_weekday)), aes(x = ans_weekday)) + 
  geom_bar() + 
  ggtitle("Distribution of answers posted over a week")

plot1 <- ggplot(x, aes(x = post_hour)) + 
  geom_bar() + 
  ggtitle("Distribution of questions posted over a day") +
  scale_x_continuous("Hour of the Day", breaks = seq(0, 23, by = 1))

plot2 <- ggplot(subset(x, !is.na(ans_weekday)), aes(x = ans_hour)) + 
  geom_bar() + 
  ggtitle("Distribution of answers posted over a day") + 
  scale_x_continuous("Hour of the Day", breaks = seq(0, 23, by = 1))

grid.arrange(plot1, plot2, nrow=2, ncol=1)
```


