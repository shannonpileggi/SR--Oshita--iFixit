---
title: "Exploring variables in the data"
output: 
  html_document: default
  pdf_document: default

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, Importing and setting up the data , include = FALSE}
dir <- file.path(getwd(),"data")
out <- read.csv(file.path(dir, "answers_data.csv"))

library(dplyr)
out_english <- out %>% 
                tbl_df() %>%
                filter(langid == "en")

out_english$time_until_answer <- (out_english$first_answer_date - out_english$post_date)/3600
empty <- which(is.na(out_english$time_until_answer))
for (i in empty) {
  out_english$time_until_answer[i] <- (out_english$download_date[i] - out_english$post_date[i])/3600
}

library(ggplot2)
library(survival)
library(survminer)
library(epiR)
library(stringr)
library(rebus)
```


```{r, functions, include = FALSE}
#function to plot KM_curves with ggplot (use when it's hard to read ggsurvplot output)
#takes survfit object, data set to work with, and optional x-axis limits as input, outputs ggplot KM curves

plot_surv <- function(survfit, data, xlim = NULL) {
  library(ggfortify)
  library(directlabels)
  
  df <- fortify(survfit, data = data)
  
  if (missing(xlim)) {
      
    if (!("strata" %in% names(df))) {
        ggplot(df, aes(x = time, y = surv)) + 
          geom_line() + 
          scale_y_continuous("Survival Probability") +
          scale_x_continuous("Time")
          ggtitle("Survival Curve")
        }
    if ("strata" %in% names(df)) {
      ggplot(df, aes(x = time, y = surv, color = strata)) + 
        geom_line() + 
        scale_y_continuous("Survival Probabilities") +
        scale_x_continuous("Time") + 
        ggtitle("Survival Curves") + 
        geom_dl(aes(label = strata), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.5))
    }
  } else {
      
      if (!("strata" %in% names(df))) {
        ggplot(df, aes(x = time, y = surv)) + 
          geom_line() + 
          scale_y_continuous("Survival Probability") +
          scale_x_continuous("Time", limits = xlim)
          ggtitle("Survival Curve")
      }

      if ("strata" %in% names(df)) {
        ggplot(df, aes(x = time, y = surv, color = strata)) + 
          geom_line() + 
          scale_y_continuous("Survival Probabilities") +
          scale_x_continuous("Time", limits = xlim) + 
          ggtitle("Survival Curves") + 
          geom_dl(aes(label = strata), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.5))
      }
  }
}

#function to output logrank test and survival curves
#takes in Surv object, data set, and categorical variable 
# surv_analysis <- function(surv_object, group, data, xlim) {
#   
#   survdiff(surv_object ~ group, data)
#   
#   if (missing(xlim)) {
#     KM <- survfit(surv_object ~ group, data)
#     plot_surv(KM, data)
#   } else {
#     KM <- survfit(surv_object ~ group, data)
#     plot_surv(KM, data, xlim)
#   }
# }
# surv_analysis(surv_object, group = "category", data = out_english)

```


### Category

##### number of questions within each category

```{r, category1, echo = FALSE}
categories <- out_english %>%
                group_by(category) %>%
                summarise(n = n()) %>%
                arrange(desc(n))
categories
```

##### median/average time by category

```{r, category2, echo = FALSE}
sorted <- out_english %>% 
            group_by(category) %>%
            summarise(n = n(), avg_time = mean(time_until_answer), median_time = median(time_until_answer)) %>%
            arrange(median_time)
sorted
```

* **Categories with lowest median time_until_answer values:** `r as.character(sorted$category[1:5])`
* **Category with longest median time_until_answer:** `r last(as.character(sorted$category))`

##### log-rank test

```{r, category3, echo = FALSE}

surv_object <- Surv(out_english$time_until_answer, out_english$answered, type = "right")

survdiff(surv_object~category, data = out_english)
```

##### survival curves  

```{r, echo = FALSE}
KM_category <- survfit(surv_object~category, data = out_english)

plot_surv(KM_category, data = out_english)
```



### Whether or not the question was categorized correctly

```{r, categorized correctly?, echo = FALSE}
prop_incorrect <- sum(is.na(out_english$category))/nrow(out_english)
```

* `r round(prop_incorrect*100, 2)`% of questions were categorized incorrectly

##### log-rank test

```{r, echo = FALSE}
out_english$categorized <- 0
out_english$categorized[!is.na(out_english$category)] <- 1

survdiff(surv_object~categorized, data = out_english)
```

##### survival curves 

```{r, echo = FALSE}
KM_correct <- survfit(surv_object ~ as.factor(categorized), data = out_english)
plot_surv(KM_correct, data = out_english, xlim = c(0,100))
```



### Does the title contain a question mark

```{r, question mark, echo = FALSE}
out_english$contain_question <- str_detect(out_english$title, pattern = QUESTION)

prop_contain <- sum(out_english$contain_question)/nrow(out_english)

true <- out_english %>% 
  filter(contain_question == T)
prop_answered <- sum(true$answered)/nrow(true)
```
* `r round(prop_contain * 100, 2)`% of questions contain a question mark
* `r round(prop_answered * 100, 2)`% of questions with a question mark were answered

##### median time grouped by whether or not question contains: '?'

```{r, echo = FALSE}
out_english %>%
  group_by(contain_question) %>%
  summarise(median_time = median(time_until_answer), n = n()) %>%
  arrange(median_time)
```

* indicates that questions with a '?' tend to have shorter answer times than questions without 

##### proportion of questions with '?' and median time grouped by category

```{r, echo = FALSE}
c <- out_english %>% 
    group_by(category) %>%
    summarise(n = n(), proportion_with_question = sum(contain_question)/n, median_time = median(time_until_answer)) %>%
    arrange(desc(proportion_with_question))
c
```

* **categories with highest proportion of questions containing question marks:** `r as.character(c$category[1:5])`

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ contain_question, data = out_english)
```

##### survival curves

```{r, echo = FALSE}
KM_question <- survfit(surv_object ~ contain_question, data = out_english)
plot_surv(KM_question, data = out_english)
```


### Searching for "tried" and "searched" in the text variable
```{r, tried, echo = FALSE}
out_english$tried <- str_detect(as.character(out_english$text), pattern = or("tried", "searched"))
prop_tried <- sum(out_english$tried)/nrow(out_english)
```

* `r round(prop_tried * 100, 2)`% of questions contain either "tried" or "searched"

##### median time/average daily views grouped by whether or not question contains "tried"/"searched"
```{r, echo = FALSE}
out_english %>%
  group_by(tried) %>%
  summarise(median_time = median(time_until_answer), avg_daily = mean(daily_views), n = n()) %>%
  arrange(median_time)
```

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(tried), data = out_english)
```

##### survival curves

```{r, echo = FALSE}
KM_tried <- survfit(surv_object ~ as.factor(tried), data = out_english)

plot_surv(KM_tried, data = out_english)
```


### Title Length

##### distribution of title lengths

```{r, title length, echo = FALSE}
out_english$title_length <- str_length(out_english$title)

ggplot(out_english, aes(x = title_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Question Title") + 
  ggtitle("Distribution of Title Lengths")
```

```{r, echo = FALSE}
sum_length <- summary(out_english$title_length)
```

* **min title length:** `r sum_length[1]` characters
* **max title length:** `r sum_length[6]` characters
* **mean title length:** `r sum_length[4]`
* **median:** `r sum_length[3]`

##### average title length grouped by answered/unanswered questions

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_length = mean(title_length), n = n())
```

##### average title length and median time grouped by category 

```{r, echo = FALSE}
out_english %>%
  group_by(category) %>%
  summarise(n = n(), avg_length = mean(title_length), median_time = median(time_until_answer)) %>%
  arrange(desc(avg_length))
```

### Text Length

```{r, text length, echo = FALSE}
out_english$text_length <- str_length(out_english$text)

ggplot(out_english, aes(x = text_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Text") + 
  ggtitle("Distribution of Text Lengths")

sum_text <- summary(out_english$text_length)
```

* **min text length:** `r sum_text[1]` characters
* **max text length:** `r sum_text[6]` characters
* **mean text length:** `r sum_text[4]`
* **median:** `r sum_text[3]`

##### average/median text length and median time grouped by answered/unanswered questions

* may be evidence that questions with longer text length tend to get answered

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_length = mean(text_length), median_length = median(text_length), median_time = median(time_until_answer), n = n())
```

##### determining which categories have the longest text lengths

```{r, echo = FALSE}
out_english %>%
  group_by(category) %>%
  summarise(avg_length = mean(text_length), median_length = median(text_length), n = n()) %>%
  arrange(desc(avg_length))
```

### Device length

```{r, device length, echo = FALSE}
out_english$device_length <- str_length(out_english$device)

ggplot(out_english, aes(x = device_length)) + 
  geom_histogram() + 
  scale_x_continuous("Length of Device Name") + 
  ggtitle("Distribution of Device Name Lengths")

sum_device <- summary(out_english$device_length)
```

* **min length:** `r sum_device[1]`
* **max length:** `r sum_device[6]`
* **mean length:** `r sum_device[4]`
* **median length:** `r sum_device[3]`

##### average and median device length grouped by answered/unanswered questions

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(answered)) %>%
  summarise(avg_length = mean(device_length), median_length = median(device_length), n = n())
```

##### which categories have the longest device name lengths

```{r, echo = FALSE}
out_english %>%
  group_by(category) %>%
  summarise(avg_length = mean(device_length), median_length = median(device_length), n = n()) %>%
  arrange(desc(avg_length))
```


### n_tags

* n_tags included in questions: `r unique(out_english$n_tags)`
```{r, number tags, echo = FALSE}
prop_notags <- sum(out_english$n_tags == 0)/nrow(out_english)
```
* `r round(prop_notags * 100,2)`% of questions don't have any tags

##### proportion table for n_tags

```{r, echo = FALSE}
round(prop.table(table(out_english$n_tags)), 3)
```

##### median time and proportion of questions answered grouped by n_tags

* questions with more tags tend to have faster answer times and are more likely to get answers

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(n_tags)) %>%
  summarise(n = n(), median_time = median(time_until_answer), proportion_answered = sum(answered)/n) %>%
  arrange(median_time)
```

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(n_tags), data = out_english)
```

##### survival curves

```{r, echo = FALSE}
KM_tags <- survfit(surv_object~as.factor(n_tags), data = out_english)
plot_surv(KM_tags, data = out_english)
```


### n_images

```{r, echo = FALSE}
prop_hasimage <- sum(out_english$n_images != 0)/nrow(out_english)
```

* `r round(prop_hasimage * 100, 2)`% of questions contain at least one image

##### frequency table for n_images

```{r, number images, echo = FALSE}
table(out_english$n_images)
```

##### median time and proportion answered grouped by whether or not question contains an image

* questions that include at least one image tend to have faster answer times

```{r, echo = FALSE}
out_english$pic_included <- 0
out_english$pic_included[out_english$n_images != 0] <- 1

out_english %>%
  group_by(as.factor(pic_included)) %>%
  summarise(median_time = median(time_until_answer), n = n(), proportion_answered = sum(answered)/n) %>%
  arrange(desc(proportion_answered))
```

##### log-rank test 

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(pic_included), data = out_english)
```

##### survival curves

```{r, echo = FALSE}
KM_pic <- survfit(surv_object~as.factor(pic_included), data = out_english)
plot_surv(KM_pic, data = out_english)
```


### new_user

```{r, echo = FALSE}
prop_new <- sum(out_english$new_user)/nrow(out_english)
```

* `r round(prop_new * 100, 2)`% of users asking a question were new

##### median time and proportion answered grouped by whether or not new user

```{r, echo = FALSE}
out_english %>% 
  group_by(as.factor(new_user)) %>%
  summarise(median_time = median(time_until_answer), n = n(), proportion_answered = sum(answered)/n) %>%
  arrange(desc(proportion_answered))
```

##### log-rank test

```{r, echo = FALSE}
survdiff(surv_object ~ as.factor(new_user), data = out_english)
```

##### survival curves

```{r, echo = FALSE}
KM_new <- survfit(surv_object~as.factor(new_user), data = out_english)
plot_surv(KM_new, data = out_english)
```


### daily_views

```{r, echo = FALSE}
ggplot(out_english, aes(x = daily_views)) + 
  geom_histogram() + 
  scale_x_continuous("Average daily views for a question") + 
  ggtitle("Distribution of Daily Views")
```

* **max average daily views for a question:** `r max(out_english$daily_views)`
* **min average daily views for a question:** `r min(out_english$daily_views)`
* **mean:** `r round(mean(out_english$daily_views), 2)`
* **median:** `r round(median(out_english$daily_views), 2)`

##### median daily view and median time grouped by category 

```{r, echo = FALSE}
out_english %>%
  group_by(category) %>%
  summarise(median_views = median(daily_views), n = n(), median_time = median(time_until_answer)) %>%
  arrange(desc(median_views))
```

##### median daily views and time grouped by n_tags

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(n_tags)) %>%
  summarise(median_views = median(daily_views), median_time = median(time_until_answer), n = n()) %>%
  arrange(desc(median_views))
```

##### median daily views and time grouped by whether or not image included

```{r, echo = FALSE}
out_english %>%
  group_by(as.factor(pic_included)) %>%
  summarise(median_views = median(daily_views), median_time = median(time_until_answer), n = n())
```

