---
title: "Summary Statistics"
output:
  html_document: default
  pdf_document: default
---

```{r, Importing and setting up the data , include = FALSE}
dir <- file.path(getwd(),"data")
out <- read.csv(file.path(dir, "answers_data.csv"))

library(dplyr)
out_english <- out %>% 
                tbl_df() %>%
                filter(langid == "en")

out_english$time_until_answer <- (out_english$first_answer_date - out_english$post_date)/3600
empty <- which(is.na(out_english$time_until_answer))
for (i in empty) {
  out_english$time_until_answer[i] <- (out_english$download_date[i] - out_english$post_date[i])/3600
}

library(ggplot2)
library(survival)
library(survminer)
library(epiR)

proportion_answered <- sum(out_english$answered)/nrow(out_english)
```

#### About the data set:

* `r nrow(out_english)` observations
* `r round(proportion_answered * 100, digits = 2)` % of questions were answered 

#### Exploring the response: time_until_answer

```{r, time_until_answer, echo = FALSE}
summary <- summary(out_english$time_until_answer)
```

* **minimum:** `r round(min(out_english$time_until_answer), 2)` hrs
* **maximum:** `r round(max(out_english$time_until_answer), 2)` hrs
* **mean:** `r round(mean(out_english$time_until_answer), 2)` hrs
* **median:** `r round(median(out_english$time_until_answer), 2)` hrs
* **first quartile:** `r round(summary[2], 2)`hrs
* **third quartile:** `r round(summary[5], 2)` hrs
* **IQR range:** `r round(summary[5] - summary[2], 2)` hrs

```{r, distribution of response, echo = FALSE}
ggplot(out_english, aes(x = time_until_answer)) + 
  geom_histogram(bins = 10) + 
  scale_x_continuous("Time (hours)") +
  ggtitle("Distribution of time_until_answer values")
```


### Survival Analysis Statistics

##### Survival Time Statistics based off of KM Estimator 
```{r, survival analysis statistics, echo = FALSE}
surv_object <- Surv(out_english$time_until_answer, out_english$answered, type = "right")

KM <- survfit(surv_object ~ 1, conf.type = "log-log")

s <- summary(KM)
round(s$table, 2)
```

* **Min survival probability:** `r round(min(s$surv), 2)`
* **Max survival probability:** `r round(max(s$surv), 2)`
* **rmean survival time:** `r round(s$table[5], 2)` hrs
* **SE of rmean:** `r round(s$table[6], 2)` hrs
* **Median survival time:** `r round(s$table[7], 2)` hrs
* **95% confidence interval for the median:** (`r round(s$table[8], 2)`,`r round(s$table[9], 2)`)


##### Percentiles

```{r, percentiles, echo = FALSE}
quant <- quantile(KM, c(0.01, 0.10, 0.25, 0.30, 0.50, 0.75))
round(quant[[1]], 3)
```
* **Interpretations:**
    + By `r round(quant$quantile[1], 2)` hrs 1% of the questions have been answered
    + By `r round(quant$quantile[2], 2)` hrs 10% of the questions have been answered
    + By `r round(quant$quantile[3], 2)` hrs 25% of the questions have been answered
    + By `r round(quant$quantile[4], 2)` hrs 30% of the questions have been answered
    + By `r round(quant$quantile[5], 2)` hrs 50% of the questions have been answered
    + 75th percentile doesn't exist (lowest survival probability: `r round(min(summary(KM)$surv),2)`)


##### Survival Curves

* Survival curve shows that survival probability drops immediately after question is posted. Within a few hours after posting, survival probability levels out, hovers around 0.35 (never hits 0).

```{r, survival curves, echo = FALSE}
ggsurvplot(KM, data = out_english, risk.table = TRUE, xlab = "Time (hours)", main = "KM Curve")
ggsurvplot(KM, data = out_english, risk.table = FALSE, xlab = "Time (hours)", main = "KM Curve (zoomed in)", xlim = c(0,50), break.x.by = 10)
```


### Instantaneous Hazard Rates (based off of KM estimates)

```{r, instant hazard, echo = FALSE}
h.hat <- epi.insthaz(KM, conf.level = 0.95) #instantaneous hazard on basis of KM 
round(head(h.hat), 3)
```

* **Max instant hazard rate:** `r round(max(h.hat$est), 2)` at time: `r round(h.hat$time[which(h.hat$est == max(h.hat$est))], 2)` hrs 
* **Min instant hazard rate:** `r round(min(h.hat$est), 2)`

```{r, instant hazard plots, echo = FALSE}
ggplot(h.hat, aes(x = time, y = est)) + 
  geom_line() + 
  scale_x_continuous("Time (hours)") + 
  scale_y_continuous("Instantaneous Hazard Rate") + 
  ggtitle("Instantaneous Hazard Rate Plot")

ggplot(h.hat, aes(x = time, y = est)) + 
  geom_line() + 
  scale_x_continuous("Time (hours)", limits = c(0,50)) + 
  scale_y_continuous("Instantaneous Hazard Rate") + 
  ggtitle("Instantaneous Hazard Rate Plot (zoomed in)")
```

* Instant hazard rate of a question getting answered drops to 0 and stays there pretty consistently after about 45 hours
* Right before that 45th hour, hazard spikes up twice to about 1.25


### Cumulative Hazard Rates

* Nelson-Aalen plot: rate of increase of H(t) starts to decrease/levels out around ~50 hours (indicates that instantaneous hazard is decreasing)

```{r, cumulative hazard, echo = FALSE}
#KM estimator of cumulative hazard 
fit <- data.frame(surv = s$surv, time = s$time, n.event = s$n.event, n.risk = s$n.risk)
fit$H.hat <- -log(fit$surv)

ggplot(fit, aes(x = time, y = H.hat)) + 
  geom_line() + 
  scale_x_continuous("Time (hours)") + 
  scale_y_continuous("Cumulative Hazard Rate based off of KM Estimates") + 
  ggtitle("Cumulative Hazard Plot (KM)")

#Nelson-Aalen estimator of cumulative hazard
fit$H.tilde <- cumsum(fit$n.event/fit$n.risk)

ggplot(fit, aes(x = time, y = H.tilde)) +
  geom_line() +
  scale_x_continuous("Time (hours)", limits = c(0,1000)) +
  scale_y_continuous("Cumulative Hazard Rate based off of Nelson Aalen Type") + 
  ggtitle("Cumulative Hazard Plot (Nelson-Aalen)")
```

