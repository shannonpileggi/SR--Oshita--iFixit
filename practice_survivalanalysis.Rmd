---
title: "Practicing with Survival Analysis"
author: "Lisa Oshita"
date: "July 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### importing/setting up data, creating survival object
```{r}
#import data
dir <- file.path(getwd(),"data")
out <- read.csv(file.path(dir, "answers_data.csv"))

#creating time to event variable
out$time_until_answer <- out$first_answer_date - out$post_date
#filling in the NAs
empty <- which(is.na(out$time_until_answer))
for (i in empty) {
  out$time_until_answer[i] <- out$download_date[i] - out$post_date[i]
}

#subsetting to include only observations in english with positive time to event values
library(dplyr)
out1 <- out %>% 
          tbl_df() %>% 
          filter(langid == "en") %>%
          filter(time_until_answer > 0)

library(survival)

#creating survival object
surv_object <- Surv(out1$time_until_answer, out1$answered, type = "right")
```

### km estimator
* to do KM estimate for different groups: survfit(surv_object ~ category_to_groupby)
* confidence intervals: CI for S(t) are pointwise intervals
* can use log-log approach (specify conf.type = "log-log") to prevent upper limits from exceeding 1
```{r}
#KM estimator
KM.obj <- survfit(surv_object ~ 1, conf.type = "plain")
str(KM.obj)
summary(KM.obj)

#defining tick marks for x-axis
min <- min(out_english$time_until_answer)
max <- max(out_english$time_until_answer)

#cb <- confBands(surv_object, confLevel=0.95, type="hall") #for confidence bands
plot(KM.obj, main = "KM Curve", xlab = "Seconds", ylab = "Surival Probability", xaxt = "n")
axis(side = 1, at = seq(min, max, by = (max-min)/10), tick = TRUE) #adding more detailed x axis
#lines(cb$time, cb$lower, lty=3, type="s") #for confidence bands
#lines(cb$time, cb$upper, lty=3, type="s")
```

### instantaneous hazard using epiR package
```{r}
library(epiR)
h.hat <- epi.insthaz(KM.obj, conf.level = 0.95)
plot(h.hat$time, h.hat$est, main = "h(t) plot", xlab = "Time", ylab = "Hazard Rate", type = "s", xaxt = "n")
axis(side = 1, at = seq(min, max, by = (max-min)/10), tick = TRUE)

plot(h.hat$time, h.hat$est, main = "h(t) plot (zoomed in)", xlab = "Time", ylab = "Hazard Rate", xlim = c(20,1000000), type = "s", xaxt = "n")
axis(side = 1, at = seq(min, max, by = (max-min)/10), tick = TRUE)

#there is a spike in instantaneous hazard before 200,000 seconds (55.5 hours or 2.31 days)
```

### estimating the cumulative hazard function
* H(t) = âˆ’log S(t), or can use the Nelson-Aalen estimator
* no function in survival package to do this
* working with instructions from OpenIntro Survival analysis in r pdf 
```{r}
#Kaplan Meier estimator of cumulative hazard
fit <- summary(survfit(surv_object ~ 1))
H.hat <- -log(fit$surv)
H.hat <- c(H.hat, tail(H.hat, 1)) #all this did was repeat the last entry? 

#Nelson Aalen estimator
h <- fit$n.event / fit$n.risk
H.tilde <- cumsum(h)
H.tilde <- c(H.tilde, tail(H.tilde, 1))

#plotting both KM and Nelson Aalen on same graph
plot(c(fit$time, 6500000), H.hat, xlab="Time", ylab="Cumulative Hazard", ylim = range(c(H.hat, H.tilde)), type = "s", xaxt = "n")
points(c(fit$time, 6500000), H.tilde, lty=2, type="s", xaxt = "n")
legend("bottomright", legend=c("H.hat","H.tilde"), lty=1:2)
axis(side = 1, at = seq(min, max, by = (max-min)/10), tick = TRUE)
#KM and Nelson Aalen estimators look the same- because large data set? 
#Rate of increase in cumulative hazard spikes up drastically (immediately after question is posted)- indicating that hazard is increasing on that interval. Rate of increase in cumulative hazard after a certain point, levels out pretty quickly- indicating that hazard is decreasing
```

### mean, medians, percentiles 
```{r}
#to get mean and median
print(KM.obj, print.rmean=TRUE)

#finding percentiles 
library(survival)
quantile(KM.obj, c(0.01, 0.10, 0.25, 0.30, 0.50, 0.75))
#getting NA for 0.75 because our lowest S(t) = 0.3410254
```

  

