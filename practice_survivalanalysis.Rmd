---
title: "Practicing with Survival Analysis"
author: "Lisa Oshita"
date: "July 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### importing/setting up data, creating survival object
```{r}
#import data
dir <- file.path(getwd(),"data")
out <- read.csv(file.path(dir, "answers_data.csv"))

#creating time to event variable
out$time_until_answer <- out$first_answer_date - out$post_date
#filling in the NAs
empty <- which(is.na(out$time_until_answer))
for (i in empty) {
  out$time_until_answer[i] <- out$download_date[i] - out$post_date[i]
}

#subsetting to include only observations in english with positive time to event values
library(dplyr)
out1 <- out %>% 
          tbl_df() %>% 
          filter(langid == "en") %>%
          filter(time_until_answer > 0)

library(survival)

#creating survival object
surv_object <- Surv(out1$time_until_answer, out1$answered)
```

### km estimator
* to do KM estimate for different groups: survfit(surv_object ~ category_to_groupby)
* confidence intervals: CI for S(t) are pointwise intervals
* can use log-log approach (specify conf.type = "log-log") to prevent upper limits from exceeding 1
```{r}
#KM estimator
KM.obj <- survfit(surv_object ~ 1, conf.type = "plain")
str(KM.obj)
summary(KM.obj)

#cb <- confBands(surv_object, confLevel=0.95, type="hall") #for confidence bands
plot(KM.obj, main = "KM Curve", xlab = "Seconds", ylab = "Surival Probability")
#lines(cb$time, cb$lower, lty=3, type="s") #for confidence bands
#lines(cb$time, cb$upper, lty=3, type="s")

#estimate means survival time E(T)
#estimate percentiles of survival time
```

### instantaneous hazard using epiR package
```{r}
library(epiR)
h.hat <- epi.insthaz(KM.obj, conf.level = 0.95)
plot(h.hat$time, h.hat$est, main = "h(t) plot", xlab = "Time", ylab = "Hazard Rate", type = "s")
plot(h.hat$time, h.hat$est, main = "h(t) plot (zoomed in)", xlab = "Time", ylab = "Hazard Rate", xlim = c(20,1500000), type = "s")

```

### estimating the cumulative hazard function
* H(t) = âˆ’log S(t), or can use the Nelson-Aalen estimator
* no function in survival package to do this
* working with instructions from OpenIntro Survival analysis in r pdf 
```{r}
#Kaplan Meier estimator of cumulative hazard
fit <- summary(survfit(surv_object ~ 1))
H.hat <- -log(fit$surv)
H.hat <- c(H.hat, tail(H.hat, 1)) #all this did was repeat the last entry? 

#Nelson Aalen estimator
h <- fit$n.event / fit$n.risk
H.tilde <- cumsum(h)
H.tilde <- c(H.tilde, tail(H.tilde, 1))

#plotting both KM and Nelson Aalen on same graph
plot(c(fit$time, 6500000), H.hat, xlab="Time", ylab="Cumulative Hazard", ylim = range(c(H.hat, H.tilde)), type = "s")
points(c(fit$time, 6500000), H.tilde, lty=2, type="s")
legend("topleft", legend=c("H.hat","H.tilde"), lty=1:2)
#KM and Nelson Aalen estimators look the same- because large data set? 
```

### mean, medians, percentiles 
```{r}
#at 30,158 seconds (502.6 min), 50% of the questions have been answered
#mean survival time = 2,748,083 (45801.38 min, 763.3563hrs, 31.8 days)
#upper limit = largest observation in time to event var
print(KM.obj, print.rmean=TRUE)

#finding percentiles 
library(survival)
quantile(KM.obj, c(0.01, 0.10, 0.25, 0.30, 0.50, 0.75))
#getting NA for 0.75 because our lowest S(t) = 0.3410254
```

* interpreting quantiles: 
* at time = 138 seconds (2.3 min), 1% of the questions have been answered
*           802 seconds (13.4 min), 10% of the questions have been answered
*           2,883 seconds (48.1 min), 25% of the questions have been answered

### exploring time_until_answered
* largest time_until_answered = 89.97 days (obs = 7807), and is censored
* shortest time_until_answered = 23 seconds (obs = 7485) 
```{r}
sum(out1$answered)/length(out1$answered)
#64.4% of observations are complete
#35.6% of observations are censored

library(ggplot2)
ggplot(out1, aes(x = time_until_answer)) + 
  geom_histogram() + 
  scale_x_continuous(limits = c(20, 30000))
```




